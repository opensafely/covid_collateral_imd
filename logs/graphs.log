
. cap mkdir ./output/graphs

. 
. * CVD outcomes only
. * file local:  population
. local outcomes "mi_admission stroke_admission heart_failure_admission vte_adm
> ission"

. *local file "has_t1_diabetes has_t2_diabetes population has_asthma has_copd h
> as_copd"
. forvalues i=1/4 {
  2.     local this_outcome: word `i' of `outcomes'
  3.     *local population: word `i' of `file'
. * Generates graphs for each outcome
. * IMD
.         import delimited using ./output/measures/measure_`this_outcome'_imd_r
> ate.csv, numericcols(4) clear
  4.         * IMD shouldn't be missing 
.         count if imd==0 | imd==.
  5.         * drop missings (should only be in dummy data)
.         drop if imd==0 | imd==.
  6.         * Generate percentage of population with outcome
.         gen percent = value*100
  7.         * Format date
.         gen dateA = date(date, "YMD")
  8.         drop date
  9.         format dateA %dD/M/Y
 10.         * reshape dataset so columns with percentage for each IMD category
>  
.         reshape wide value percent population `this_outcome', i(dateA) j(imd)
 11.         describe
 12.         * Labelling IMD variables
.         label var percent1 "IMD 1"
 13.         label var percent2 "IMD 2"
 14.         label var percent3 "IMD 3"
 15.         label var percent4 "IMD 4"
 16.         label var percent5 "IMD 5"
 17. 
.         * Generate line graph
.         graph twoway line percent1 percent2 percent3 percent4 percent5 date, 
> tlabel(01Jan2018(120)31Dec2021, angle(45) ///
>         format(%dM-CY) labsize(small)) ytitle("Percentage") xtitle("Date") yl
> abel(#5, labsize(small) ///
>         angle(0)) yscale(r(0) titlegap(*10)) xmtick(##6) legend(row(1) size(s
> mall) ///
>         title("IMD categories", size(small))) graphregion(fcolor(white))
 18. 
.         graph export ./output/graphs/line_`this_outcome'_imd.svg, as(svg) rep
> lace
 19. 
.         * Plotting first derivative i.e. difference between current percent a
> nd previous months percent
.         forvalues j=1/5 {
 20.             sort dateA
 21.             gen first_derivative`j' = percent`j' - percent`j'[_n-1]
 22.             }
 23.         * Label variables 
.         label var first_derivative1 "IMD 1"
 24.         label var first_derivative2 "IMD 2"
 25.         label var first_derivative3 "IMD 3"
 26.         label var first_derivative4 "IMD 4"
 27.         label var first_derivative5 "IMD 5"
 28.         * Plot this
.         graph twoway line first_derivative1 first_derivative2 first_derivativ
> e3 first_derivative4 first_derivative5 date, tlabel(01Jan2018(120)31Dec2021, 
> angle(45) ///
>         format(%dM-CY) labsize(small)) ytitle("Absolute difference") xtitle("
> Date") ylabel(#5, labsize(small) ///
>         angle(0)) yscale(r(0) titlegap(*10)) xmtick(##6) legend(row(1) size(s
> mall) ///
>         title("IMD categories", size(small))) graphregion(fcolor(white))
 29. 
.         graph export ./output/graphs/line_`this_outcome'_diff_imd.svg, as(svg
> ) replace
 30.         * Export data file for output checking 
.         export delimited using ./output/graphs/line_data_`this_outcome'_diff_
> imd.csv
 31.     
.         /* Migration status
>         import delimited using ./output/measures/measure_`this_outcome'_migra
> tion_status_rate.csv, numericcols(4) clear
>         * migration status shouldn't be missing 
>         count if migration_status==.
>         * drop missings (should only be in dummy data)
>         drop if migration_status==.
>         * Generate percentage with outcome
>         gen percent = value*100 
>         * Format date
>         gen dateA = date(date, "YMD")
>         drop date
>         format dateA %dD/M/Y
>         * reshape dataset so columns with percentage for each migration categ
> ory  
>         reshape wide value percent `population' `this_outcome', i(dateA) j(mi
> gration_status)
>         describe
>         
>         label var percent0 "Non-migrant"
>         label var percent1 "Migrant"
> 
>         * Generate line graph
>         graph twoway line percent0 percent1 date, tlabel(01Jan2018(120)31Dec2
> 021, angle(45) ///
>         format(%dM-CY) labsize(small)) ytitle("Percentage") xtitle("Date") yl
> abel(#5, labsize(small) ///
>         angle(0)) yscale(r(0) titlegap(*10)) xmtick(##6) legend(row(1) size(s
> mall) ///
>         title("Migration status", size(small))) graphregion(fcolor(white))
> 
>         graph export ./output/graphs/line_`this_outcome'_migration_status.svg
> , as(svg) replace
> 
>         * Plotting first derivative i.e. difference between current percent a
> nd previous months percent
>         forvalues j=0/1 {
>             sort dateA
>             gen first_derivative`j' = percent`j' - percent`j'[_n-1]
>             }
> 
>          * Label variables 
>         label var first_derivative0 "Non-migrant"
>         label var first_derivative1 "Migrant"
> 
>         * Plot this
>         graph twoway line first_derivative0 first_derivative1 date, tlabel(01
> Jan2018(120)31Dec2021, angle(45) ///
>         format(%dM-CY) labsize(small)) ytitle("Difference (%)") xtitle("Date"
> ) ylabel(#5, labsize(small) ///
>         angle(0)) yscale(r(0) titlegap(*10)) xmtick(##6) legend(row(1) size(s
> mall) ///
>         title("Migration status", size(small))) graphregion(fcolor(white))
> 
>         graph export ./output/graphs/line_`this_outcome'_diff_migration_statu
> s.svg, as(svg) replace
>         * Export data file for output checking 
>         export delimited using ./output/graphs/line_data_`this_outcome'_diff_
> migration_status.csv
>         */
.     }
(5 vars, 276 obs)
  46
(46 observations deleted)
(note: j = 1 2 3 4 5)

Data                               long   ->   wide
-----------------------------------------------------------------------------
Number of obs.                      230   ->      46
Number of variables                   6   ->      21
j variable (5 values)               imd   ->   (dropped)
xij variables:
                                  value   ->   value1 value2 ... value5
                                percent   ->   percent1 percent2 ... percent5
                             population   ->   population1 population2 ... popu
> lation5
                           mi_admission   ->   mi_admission1 mi_admission2 ... 
> mi_admission5
-----------------------------------------------------------------------------

Contains data
  obs:            46                          
 vars:            21                          
-------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
-------------------------------------------------------------------------------
dateA           float   %dD/M/Y               
mi_admission1   byte    %8.0g                 1 mi_admission
population1     int     %8.0g                 1 population
value1          float   %9.0g                 1 value
percent1        float   %9.0g                 1 percent
mi_admission2   byte    %8.0g                 2 mi_admission
population2     int     %8.0g                 2 population
value2          float   %9.0g                 2 value
percent2        float   %9.0g                 2 percent
mi_admission3   byte    %8.0g                 3 mi_admission
population3     int     %8.0g                 3 population
value3          float   %9.0g                 3 value
percent3        float   %9.0g                 3 percent
mi_admission4   byte    %8.0g                 4 mi_admission
population4     int     %8.0g                 4 population
value4          float   %9.0g                 4 value
percent4        float   %9.0g                 4 percent
mi_admission5   byte    %8.0g                 5 mi_admission
population5     int     %8.0g                 5 population
value5          float   %9.0g                 5 value
percent5        float   %9.0g                 5 percent
-------------------------------------------------------------------------------
Sorted by: dateA
(note: file ./output/graphs/line_mi_admission_imd.svg not found)
(file ./output/graphs/line_mi_admission_imd.svg written in SVG format)
(1 missing value generated)
(1 missing value generated)
(1 missing value generated)
(1 missing value generated)
(1 missing value generated)
(note: file ./output/graphs/line_mi_admission_diff_imd.svg not found)
(file ./output/graphs/line_mi_admission_diff_imd.svg written in SVG format)
file ./output/graphs/line_data_mi_admission_diff_imd.csv saved
(5 vars, 276 obs)
  46
(46 observations deleted)
(note: j = 1 2 3 4 5)

Data                               long   ->   wide
-----------------------------------------------------------------------------
Number of obs.                      230   ->      46
Number of variables                   6   ->      21
j variable (5 values)               imd   ->   (dropped)
xij variables:
                                  value   ->   value1 value2 ... value5
                                percent   ->   percent1 percent2 ... percent5
                             population   ->   population1 population2 ... popu
> lation5
                       stroke_admission   ->   stroke_admission1 stroke_admissi
> on2 ... stroke_admission5
-----------------------------------------------------------------------------

Contains data
  obs:            46                          
 vars:            21                          
-------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
-------------------------------------------------------------------------------
dateA           float   %dD/M/Y               
stroke_admiss~1 byte    %8.0g                 1 stroke_admission
population1     int     %8.0g                 1 population
value1          float   %9.0g                 1 value
percent1        float   %9.0g                 1 percent
stroke_admiss~2 byte    %8.0g                 2 stroke_admission
population2     int     %8.0g                 2 population
value2          float   %9.0g                 2 value
percent2        float   %9.0g                 2 percent
stroke_admiss~3 byte    %8.0g                 3 stroke_admission
population3     int     %8.0g                 3 population
value3          float   %9.0g                 3 value
percent3        float   %9.0g                 3 percent
stroke_admiss~4 byte    %8.0g                 4 stroke_admission
population4     int     %8.0g                 4 population
value4          float   %9.0g                 4 value
percent4        float   %9.0g                 4 percent
stroke_admiss~5 byte    %8.0g                 5 stroke_admission
population5     int     %8.0g                 5 population
value5          float   %9.0g                 5 value
percent5        float   %9.0g                 5 percent
-------------------------------------------------------------------------------
Sorted by: dateA
(note: file ./output/graphs/line_stroke_admission_imd.svg not found)
(file ./output/graphs/line_stroke_admission_imd.svg written in SVG format)
(1 missing value generated)
(1 missing value generated)
(1 missing value generated)
(1 missing value generated)
(1 missing value generated)
(note: file ./output/graphs/line_stroke_admission_diff_imd.svg not found)
(file ./output/graphs/line_stroke_admission_diff_imd.svg written in SVG format)
file ./output/graphs/line_data_stroke_admission_diff_imd.csv saved
(5 vars, 276 obs)
  46
(46 observations deleted)
(note: j = 1 2 3 4 5)

Data                               long   ->   wide
-----------------------------------------------------------------------------
Number of obs.                      230   ->      46
Number of variables                   6   ->      21
j variable (5 values)               imd   ->   (dropped)
xij variables:
                                  value   ->   value1 value2 ... value5
                                percent   ->   percent1 percent2 ... percent5
                             population   ->   population1 population2 ... popu
> lation5
                heart_failure_admission   ->   heart_failure_admission1 heart_f
> ailure_admission2 ... heart_failure_admission5
-----------------------------------------------------------------------------

Contains data
  obs:            46                          
 vars:            21                          
-------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
-------------------------------------------------------------------------------
dateA           float   %dD/M/Y               
heart_failure~1 byte    %8.0g                 1 heart_failure_admission
population1     int     %8.0g                 1 population
value1          float   %9.0g                 1 value
percent1        float   %9.0g                 1 percent
heart_failure~2 byte    %8.0g                 2 heart_failure_admission
population2     int     %8.0g                 2 population
value2          float   %9.0g                 2 value
percent2        float   %9.0g                 2 percent
heart_failure~3 byte    %8.0g                 3 heart_failure_admission
population3     int     %8.0g                 3 population
value3          float   %9.0g                 3 value
percent3        float   %9.0g                 3 percent
heart_failure~4 byte    %8.0g                 4 heart_failure_admission
population4     int     %8.0g                 4 population
value4          float   %9.0g                 4 value
percent4        float   %9.0g                 4 percent
heart_failure~5 byte    %8.0g                 5 heart_failure_admission
population5     int     %8.0g                 5 population
value5          float   %9.0g                 5 value
percent5        float   %9.0g                 5 percent
-------------------------------------------------------------------------------
Sorted by: dateA
(note: file ./output/graphs/line_heart_failure_admission_imd.svg not found)
(file ./output/graphs/line_heart_failure_admission_imd.svg written in SVG forma
> t)
(1 missing value generated)
(1 missing value generated)
(1 missing value generated)
(1 missing value generated)
(1 missing value generated)
(note: file ./output/graphs/line_heart_failure_admission_diff_imd.svg not found
> )
(file ./output/graphs/line_heart_failure_admission_diff_imd.svg written in SVG 
> format)
file ./output/graphs/line_data_heart_failure_admission_diff_imd.csv saved
(5 vars, 276 obs)
  46
(46 observations deleted)
(note: j = 1 2 3 4 5)

Data                               long   ->   wide
-----------------------------------------------------------------------------
Number of obs.                      230   ->      46
Number of variables                   6   ->      21
j variable (5 values)               imd   ->   (dropped)
xij variables:
                                  value   ->   value1 value2 ... value5
                                percent   ->   percent1 percent2 ... percent5
                             population   ->   population1 population2 ... popu
> lation5
                          vte_admission   ->   vte_admission1 vte_admission2 ..
> . vte_admission5
-----------------------------------------------------------------------------

Contains data
  obs:            46                          
 vars:            21                          
-------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
-------------------------------------------------------------------------------
dateA           float   %dD/M/Y               
vte_admission1  byte    %8.0g                 1 vte_admission
population1     int     %8.0g                 1 population
value1          float   %9.0g                 1 value
percent1        float   %9.0g                 1 percent
vte_admission2  byte    %8.0g                 2 vte_admission
population2     int     %8.0g                 2 population
value2          float   %9.0g                 2 value
percent2        float   %9.0g                 2 percent
vte_admission3  byte    %8.0g                 3 vte_admission
population3     int     %8.0g                 3 population
value3          float   %9.0g                 3 value
percent3        float   %9.0g                 3 percent
vte_admission4  byte    %8.0g                 4 vte_admission
population4     int     %8.0g                 4 population
value4          float   %9.0g                 4 value
percent4        float   %9.0g                 4 percent
vte_admission5  byte    %8.0g                 5 vte_admission
population5     int     %8.0g                 5 population
value5          float   %9.0g                 5 value
percent5        float   %9.0g                 5 percent
-------------------------------------------------------------------------------
Sorted by: dateA
(note: file ./output/graphs/line_vte_admission_imd.svg not found)
(file ./output/graphs/line_vte_admission_imd.svg written in SVG format)
(1 missing value generated)
(1 missing value generated)
(1 missing value generated)
(1 missing value generated)
(1 missing value generated)
(note: file ./output/graphs/line_vte_admission_diff_imd.svg not found)
(file ./output/graphs/line_vte_admission_diff_imd.svg written in SVG format)
file ./output/graphs/line_data_vte_admission_diff_imd.csv saved

. 
. 
end of do-file

. . file open output using "/tmp/102_graphs.do.i9YU.out", write text replace

. . file write output "success" 

. . file close output

. 
end of do-file


